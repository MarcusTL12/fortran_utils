module hash_mod
    use md5_mod
    use iso_c_binding
    implicit none
    !
    private
    !
    ! public     :: seed
    integer(8), parameter :: tmp = 0
    integer(8), parameter :: seed = transfer((/33797089, 832914316/), tmp)
    !
    integer, parameter :: ord1(8) = (/2, 5, 6, 3, 7, 1, 8, 4/), &
                          ord2(8) = (/4, 7, 1, 6, 8, 5, 3, 2/)
    !
    integer(8), parameter :: tmp2(64) = 0
    integer(8), parameter :: seeds1(64) = transfer((/ &
        -864173857, 1435867215, 82698859, 1027424984, 1057953894, -1659491791, &
        -2144177582, 710822282, 990363535, 775980818, -1100357150, -202832979, &
     -1643733943, -438786478, -1248833703, 852391788, 1818588961, -1021924733, &
       -916611470, 1592165984, -1990708505, -799559066, 745261382, -857673901, &
        114831455, -299214374, 800046411, 1589285082, -708497486, -1580630663, &
      -1094564606, -307502221, -786942438, -318276206, 1764132349, 2072044911, &
       1969307479, -284435069, 943629264, -1127655672, 1123715508, -803676544, &
         -1964237308, 1274049479, 42026712, 2107931334, 762460800, 1418104197, &
       -478310888, -810286663, -989827001, -1032025449, -664181938, 150185674, &
      -293187198, -300169027, -1198887114, 529100164, 2071210940, -1238889943, &
      1514191781, -1988449928, 1207845105, -1567607648, 863769837, -455764946, &
         526555178, 711049630, 1384507809, 1679952989, 123368623, -1306762193, &
      -1211403181, -1992426783, 1473781828, 21526629, -894666003, -1422506503, &
         -937288844, 1950493696, 2024560431, 1088994809, 559176709, 263609482, &
         -842766182, -493369164, 171624643, -261413699, 613179380, 2084412117, &
        -1917460204, 722726779, 1326547353, 892794180, -895452965, 1208403456, &
         20237604, -1837842015, 1170014257, 1829108242, 607996637, -130693644, &
        -2001618524, 1504091632, -154493969, 805465107, 151958447, 1865428297, &
     -1457742274, -1067995811, 1008828017, 1628721235, 1270569679, 1808475651, &
          383467168, 90663363, -1923187631, -1652199808, -436304197, 71833420, &
      1501976240, -1980288786, 440926193, -1246525327, -990965503, -749585227, &
                                                   1461289017, -929164013 &
                                                   /), tmp2), &
                             seeds2(64) = transfer((/ &
      146755146, -1931082872, 2012572659, -1039208725, 1491142685, -234817345, &
       -584104110, -1794369850, 995546521, -2057700743, 1416437595, 412392676, &
       -1038817246, -2131919353, 2016533896, 656688928, 713195592, -325389306, &
       1695542935, -2040425657, -521239714, 42322971, -230806272, -1244752992, &
              -1380159249, -1404842277, -1521302232, -1449499355, -1117014473, &
         605478716, -1166195197, -596970093, -361204782, 871532292, 749999879, &
          1318325158, 682672824, 1919482152, 1378085413, 1528204323, 92751167, &
        129694088, 1843711091, 1214184630, -1663449928, 173808753, -661172837, &
       1352246176, -1623617316, 276503718, -944341977, -1482631956, 475023001, &
    1067593789, -1560564126, 1248159285, 1853869051, -1578918048, -1597268391, &
         388985829, 1439500383, 1412674694, 857413648, -1405329005, 507885332, &
       52406831, -1874809576, 746911070, -1619110309, -1353472996, -855279777, &
      -2054825656, -931497598, 1627092910, -1000102193, 198919226, -120550417, &
       161595965, -231395283, -1456045309, -1150851535, 566987811, 1175784476, &
       1443516454, 316720556, -1879078692, -246058370, -1747889019, 500878092, &
      300823144, 310067806, -1233410161, 1567925099, -1978639759, -1931134231, &
         266985110, 393211396, 1232923400, -438147434, -1696946955, 721480091, &
        1905634306, -476911933, -725713886, 785485820, -397263078, 1400820133, &
        646784268, 2121719478, 500170082, -1708369327, -645106546, -954653706, &
         -82532910, -664925076, 1740540990, 1222305863, -1517046044, 63675219, &
     419740271, -686708149, 1561538592, -1667363890, -1982245906, -1170862415, &
                                             1273493188, 330383085, 1043020360 &
                                                   /), tmp2)
    !
    public :: hash
    interface hash
        module procedure hash_int
        module procedure hash_int8
        module procedure hash_char
    end interface
    !
    public :: fuse_hash
contains
    subroutine fuse_hash(a, b)
        implicit none
        !
        integer(8), target, intent(in) :: a
        integer(8), target, intent(inout) :: b
        integer(1), pointer :: p(:), q(:)
        integer(1) :: buff(8)
        integer :: i
        !
        call c_f_pointer(c_loc(a), p, [8])
        call c_f_pointer(c_loc(b), q, [8])
        !
        do i = 1, 8
            buff(i) = ieor(p(ord1(i)), q(ord2(i)))
        end do
        !
        b = transfer(buff, b)
    end subroutine
    !
    function md5_trunc(x)
        implicit none
        !
        integer(1), intent(in) :: x(:)
        integer(8) :: md5_trunc
        ! integer(1) :: h(16)
        integer :: i, j, k
        !
        ! h = md5(x)
        ! md5_trunc = transfer(h(1:8), md5_trunc)
        !
        k = 1
        md5_trunc = seed * size(x)
        do i = 1, size(x)
            md5_trunc = md5_trunc * seed + x(i)
            do j = 1, 8
                if (iand(x(i), ishft(int(1, 1), j - 1)) /= 0) then
                    md5_trunc = ieor(ishftc(md5_trunc, 5), seeds1(j))
                else
                    md5_trunc = ieor(ishftc(md5_trunc, 5), seeds2(j))
                end if
            end do
        end do
    end function
    !
    function hash_int(a) result(h)
        implicit none
        !
        integer, intent(in), target :: a
        integer(8), target  :: h
        integer(1), pointer :: p(:)
        !
        call c_f_pointer(c_loc(a), p, [4])
        h = md5_trunc(p)
    end function
    !
    function hash_int8(a) result(h)
        implicit none
        !
        integer(1), intent(in) :: a
        integer(8)          :: h
        !
        h = md5_trunc((/a/))
    end function
    !
    ! function hash_int_arr(a) result(h)
    !     implicit none
    !     !
    !     integer, intent(in) :: a(:)
    !     integer(8)          :: h
    !     integer :: i
    !     !
    !     h = seed
    !     !
    !     do i = 1, size(a)
    !         call fuse_hash(int(a(i), 8), h)
    !     end do
    ! end function
    !
    function hash_char(a) result(h)
        implicit none
        !
        character, intent(in) :: a
        integer(8)            :: h
        !
        h = md5_trunc((/int(ichar(a), 1)/))
    end function
    !
    ! function hash_str(a) result(h)
    !     implicit none
    !     !
    !     character, intent(in) :: a(:)
    !     integer(8)            :: h
    !     integer :: i
    !     !
    !     h = seed
    !     !
    !     do i = 1, size(a)
    !         call fuse_hash(hash(a(i)), h)
    !     end do
    ! end function
end module
